@page "/register"
@layout SMS.Components.Layout.AuthLayout
@using SMS.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@inject NavigationManager NavigationManager
@inject IDbContextFactory<CimContext> DbContextFactory
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>注册</PageTitle>

<AntDesign.Row style="margin-top: 80px; justify-content: center;">
    <AntDesign.Col Span="8">
        <AntDesign.Card>
            <TitleTemplate>
                <h3 style="text-align: center; margin: 0;">注册</h3>
            </TitleTemplate>
            <Body>
                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <AntDesign.Alert Type="@AntDesign.AlertType.Error" Message="@_errorMessage" ShowIcon="true" style="margin-bottom: 16px;" />
                }
                
                <AntDesign.Form Model="@_registerModel" Layout="@AntDesign.FormLayout.Vertical" OnFinish="OnFormFinish">
                    <AntDesign.FormItem Label="用户名">
                        <AntDesign.Input @bind-Value="@_registerModel.Username" />
                        @if (!string.IsNullOrEmpty(GetValidationError(nameof(_registerModel.Username))))
                        {
                            <div style="color: #ff4d4f; font-size: 14px; margin-top: 4px;">@GetValidationError(nameof(_registerModel.Username))</div>
                        }
                    </AntDesign.FormItem>

                    <AntDesign.FormItem Label="电子邮箱">
                        <AntDesign.Input @bind-Value="@_registerModel.Email" Type="@AntDesign.InputType.Email" />
                        @if (!string.IsNullOrEmpty(GetValidationError(nameof(_registerModel.Email))))
                        {
                            <div style="color: #ff4d4f; font-size: 14px; margin-top: 4px;">@GetValidationError(nameof(_registerModel.Email))</div>
                        }
                    </AntDesign.FormItem>

                    <AntDesign.FormItem Label="密码">
                        <AntDesign.InputPassword @bind-Value="@_registerModel.Password" />
                        @if (!string.IsNullOrEmpty(GetValidationError(nameof(_registerModel.Password))))
                        {
                            <div style="color: #ff4d4f; font-size: 14px; margin-top: 4px;">@GetValidationError(nameof(_registerModel.Password))</div>
                        }
                    </AntDesign.FormItem>

                    <AntDesign.FormItem Label="确认密码">
                        <AntDesign.InputPassword @bind-Value="@_registerModel.ConfirmPassword" />
                        @if (!string.IsNullOrEmpty(GetValidationError(nameof(_registerModel.ConfirmPassword))))
                        {
                            <div style="color: #ff4d4f; font-size: 14px; margin-top: 4px;">@GetValidationError(nameof(_registerModel.ConfirmPassword))</div>
                        }
                    </AntDesign.FormItem>

                    <AntDesign.FormItem>
                        <AntDesign.Button Type="@AntDesign.ButtonType.Primary" HtmlType="submit" Block="true" Size="@AntDesign.ButtonSize.Large" Loading="@_isSubmitting">
                            @if (_isSubmitting)
                            {
                                <span>注册中...</span>
                            }
                            else
                            {
                                <span>注册</span>
                            }
                        </AntDesign.Button>
                    </AntDesign.FormItem>
                    
                    <div style="text-align: center; margin-top: 16px;">
                        <span>已有账号？ <a href="/login">立即登录</a></span>
                    </div>
                </AntDesign.Form>
            </Body>
        </AntDesign.Card>
    </AntDesign.Col>
</AntDesign.Row>

@code {
    private string currentUser = string.Empty;
    private RegisterModel _registerModel = new();
    private string _errorMessage = string.Empty;
    private bool _isSubmitting;
    private Dictionary<string, string> _validationErrors = new();

    private string GetValidationError(string propertyName)
    {
        return _validationErrors.GetValueOrDefault(propertyName, string.Empty);
    }

    private bool ValidateModel()
    {
        _validationErrors.Clear();
        
        // 验证用户名
        if (string.IsNullOrWhiteSpace(_registerModel.Username))
        {
            _validationErrors[nameof(_registerModel.Username)] = "请输入用户名";
        }
        else if (_registerModel.Username.Length < 3 || _registerModel.Username.Length > 50)
        {
            _validationErrors[nameof(_registerModel.Username)] = "用户名长度必须在3-50个字符之间";
        }

        // 验证邮箱
        if (string.IsNullOrWhiteSpace(_registerModel.Email))
        {
            _validationErrors[nameof(_registerModel.Email)] = "请输入邮箱";
        }
        else if (!IsValidEmail(_registerModel.Email))
        {
            _validationErrors[nameof(_registerModel.Email)] = "请输入有效的邮箱地址";
        }

        // 验证密码
        if (string.IsNullOrWhiteSpace(_registerModel.Password))
        {
            _validationErrors[nameof(_registerModel.Password)] = "请输入密码";
        }
        else if (_registerModel.Password.Length < 6 || _registerModel.Password.Length > 100)
        {
            _validationErrors[nameof(_registerModel.Password)] = "密码长度必须在6-100个字符之间";
        }

        // 验证确认密码
        if (string.IsNullOrWhiteSpace(_registerModel.ConfirmPassword))
        {
            _validationErrors[nameof(_registerModel.ConfirmPassword)] = "请确认密码";
        }
        else if (_registerModel.Password != _registerModel.ConfirmPassword)
        {
            _validationErrors[nameof(_registerModel.ConfirmPassword)] = "两次输入的密码不一致";
        }

        return _validationErrors.Count == 0;
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private async Task OnFormFinish()
    {
        await HandleSubmit();
    }

    private async Task HandleSubmit()
    {
        if (_isSubmitting) 
        {
            return;
        }

        try 
        {
            _isSubmitting = true;
            StateHasChanged();

            // 手动验证
            if (!ValidateModel())
            {
                _errorMessage = "验证失败，请检查输入";
                _isSubmitting = false;
                StateHasChanged();
                return;
            }

            using var context = await DbContextFactory.CreateDbContextAsync();
            currentUser = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "currentUser") ?? string.Empty;

            // 检查用户名是否已存在
            var existingUsername = await context.SMS_Users.AnyAsync(u => u.Username == _registerModel.Username);
            if (existingUsername)
            {
                _errorMessage = "用户名已被使用";
                _isSubmitting = false;
                StateHasChanged();
                return;
            }

            // 检查邮箱是否已存在
            var existingEmail = await context.SMS_Users.AnyAsync(u => u.Email == _registerModel.Email);
            if (existingEmail)
            {
                _errorMessage = "邮箱已被使用";
                _isSubmitting = false;
                StateHasChanged();
                return;
            }

            // 创建新用户
            var user = new User
            {
                Username = _registerModel.Username,
                Email = _registerModel.Email,
                Password = BCrypt.Net.BCrypt.HashPassword(_registerModel.Password),
                // 已删除的数据库字段
                CreateUser = string.IsNullOrEmpty(currentUser) ? _registerModel.Username : currentUser,
                UpdateUser = string.IsNullOrEmpty(currentUser) ? _registerModel.Username : currentUser
            };

            try
            {
                context.SMS_Users.Add(user);
                await context.SaveChangesAsync();
                
                // 注册成功后重定向到登录页面
                NavigationManager.NavigateTo("/login", true);
            }
            catch (DbUpdateException ex)
            {
                _errorMessage = $"注册失败: {ex.Message}";
                if (ex.InnerException != null)
                {
                    _errorMessage += $" 详细信息: {ex.InnerException.Message}";
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"系统错误: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }
}
