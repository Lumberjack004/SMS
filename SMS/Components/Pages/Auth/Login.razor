@page "/login"
@layout SMS.Components.Layout.AuthLayout
@using SMS.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@inject NavigationManager NavigationManager
@inject IDbContextFactory<CimContext> DbContextFactory
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<AntDesign.Row style="margin-top: 80px; justify-content: center;">
    <AntDesign.Col Xs="22" Sm="16" Md="12" Lg="8" Xl="6">
        <AntDesign.Card>
            <Body>
                <h3 style="text-align: center; margin-bottom: 24px;">登录</h3>
                
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <AntDesign.Alert Type="@AntDesign.AlertType.Error" Message="@errorMessage" style="margin-bottom: 24px;" />
                }

                <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
                    <DataAnnotationsValidator />
                    
                    <div style="margin-bottom: 16px;">
                        <label>用户名</label>
                        <AntDesign.Input @bind-Value="loginModel.Username" Placeholder="请输入用户名" />
                        <ValidationMessage For="@(() => loginModel.Username)" />
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label>密码</label>
                        <AntDesign.InputPassword @bind-Value="loginModel.Password" Placeholder="请输入密码" />
                        <ValidationMessage For="@(() => loginModel.Password)" />
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <AntDesign.Checkbox @bind-Value="loginModel.RememberMe">记住我</AntDesign.Checkbox>
                        <a href="/forgot-password">忘记密码？</a>
                    </div>

                    <AntDesign.Button Type="@AntDesign.ButtonType.Primary" HtmlType="submit" Block="true" Size="@AntDesign.ButtonSize.Large">
                        登录
                    </AntDesign.Button>
                    
                    <div style="text-align: center; margin-top: 16px;">
                        <span>还没有账号？ <a href="/register">立即注册</a></span>
                    </div>
                </EditForm>
            </Body>
        </AntDesign.Card>
    </AntDesign.Col>
</AntDesign.Row>

@code {
    private LoginModel loginModel = new();
    private string errorMessage = string.Empty;

    [SupplyParameterFromQuery]
    public string? Error { get; set; }

    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(Error))
        {
            errorMessage = Error;
        }
    }

    private void HandleInvalidLogin(EditContext context)
    {
        errorMessage = "表单验证失败，请检查输入";
        StateHasChanged();
    }

    private class LoginModel
    {
        [Required(ErrorMessage = "请输入用户名")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "请输入密码")]
        public string Password { get; set; } = string.Empty;

        public bool RememberMe { get; set; }
    }

    private async Task HandleLogin(EditContext context)
    {
        try
        {
            using var context_db = await DbContextFactory.CreateDbContextAsync();
            
            // 根据用户名查找用户
            var user = await context_db.SMS_Users.FirstOrDefaultAsync(u => u.Username == loginModel.Username);

            if (user != null && BCrypt.Net.BCrypt.Verify(loginModel.Password, user.Password))
            {
                // 更新最后登录时间和审计字段 (使用UTC时间)
                // 已删除的数据库字段
                user.UpdateUser = user.Username; // 设置更新用户为当前登录用户
                await context_db.SaveChangesAsync();
                
                // 保存用户信息到本地存储
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "currentUser", user.Username);
                
                // 跳转到首页
                NavigationManager.NavigateTo("/home", forceLoad: true);
            }
            else
            {
                errorMessage = "用户名或密码错误";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"登录失败: {ex.Message}";
            if (ex.InnerException != null)
            {
                errorMessage += $" 详细信息: {ex.InnerException.Message}";
            }
        }
        
        StateHasChanged();
    }
}
