@page "/forgot-password"
@layout SMS.Components.Layout.AuthLayout
@using SMS.Components.Layout
@using SMS.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@inject NavigationManager NavigationManager
@inject IDbContextFactory<CimContext> DbContextFactory
@rendermode InteractiveServer

<AntDesign.Row style="margin-top: 80px; justify-content: center;">
    <AntDesign.Col Span="8">
        <AntDesign.Card>
            <TitleTemplate>
                <h3 style="text-align: center; margin: 0;">重置密码</h3>
            </TitleTemplate>
            <Body>
                @if (!string.IsNullOrEmpty(message))
                {
                    <AntDesign.Alert Type="@(isSuccess ? AntDesign.AlertType.Success : AntDesign.AlertType.Error)" 
                                   Message="@message" ShowIcon="true" style="margin-bottom: 16px;" />
                }

                <EditForm Model="@resetModel" OnValidSubmit="HandlePasswordReset" FormName="resetPasswordForm">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <AntDesign.Form Model="@resetModel" Layout="@AntDesign.FormLayout.Vertical">
                        <ChildContent Context="formContext">
                            <AntDesign.FormItem Label="用户名">
                                <InputText @bind-Value="resetModel.Username" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px;" />
                                <ValidationMessage For="@(() => resetModel.Username)" />
                            </AntDesign.FormItem>

                            <AntDesign.FormItem Label="新密码">
                                <InputText type="password" @bind-Value="resetModel.NewPassword" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px;" />
                                <ValidationMessage For="@(() => resetModel.NewPassword)" />
                            </AntDesign.FormItem>

                            <AntDesign.FormItem Label="确认新密码">
                                <InputText type="password" @bind-Value="resetModel.ConfirmPassword" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px;" />
                                <ValidationMessage For="@(() => resetModel.ConfirmPassword)" />
                            </AntDesign.FormItem>

                            <AntDesign.FormItem>
                                <AntDesign.Button Type="@AntDesign.ButtonType.Primary" HtmlType="submit" Block="true" Size="@AntDesign.ButtonSize.Large" Loading="@isSubmitting">
                                    @if (isSubmitting)
                                    {
                                        <span>重置中...</span>
                                    }
                                    else
                                    {
                                        <span>重置密码</span>
                                    }
                                </AntDesign.Button>
                            </AntDesign.FormItem>
                        </ChildContent>
                    </AntDesign.Form>
                </EditForm>
                        
                <div style="text-align: center; margin-top: 16px;">
                    <span>记起密码了？ <a href="/login">返回登录</a></span>
                </div>
            </Body>
        </AntDesign.Card>
    </AntDesign.Col>
</AntDesign.Row>

@code {
    private ResetModel resetModel = new();
    private string message = string.Empty;
    private bool isSuccess;
    private bool isSubmitting;

    private class ResetModel
    {
        [Required(ErrorMessage = "请输入用户名")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "请输入新密码")]
        [MinLength(6, ErrorMessage = "密码长度至少6位")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "请确认新密码")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    private async Task HandlePasswordReset()
    {
        if (isSubmitting) return;

        try
        {
            isSubmitting = true;

            // 验证密码确认
            if (resetModel.NewPassword != resetModel.ConfirmPassword)
            {
                message = "两次输入的密码不一致";
                isSuccess = false;
                return;
            }

            using var context = await DbContextFactory.CreateDbContextAsync();
            var user = await context.SMS_Users.FirstOrDefaultAsync(u => u.Username == resetModel.Username);

            if (user == null)
            {
                message = "用户不存在";
                isSuccess = false;
                return;
            }

            // 更新用户密码
            user.Password = BCrypt.Net.BCrypt.HashPassword(resetModel.NewPassword);
            await context.SaveChangesAsync();

            message = "密码重置成功，即将跳转到登录页面";
            isSuccess = true;

            // 等待一秒后跳转到登录页面
            await Task.Delay(1500);
            NavigationManager.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            message = $"密码重置失败: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
}
